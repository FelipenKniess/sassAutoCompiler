<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Page Title</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/css/main.css">
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
</head>
<body>
    <div class="content">
        <header>
            <h1 style="display:block;text-align:center;">Welcome to Auto Compiler!</h1>
        </header>
        
        <div id="filtros">
            <div class="conteudo">
                <div id="btn-sprint" class="toggle-button col-2">
                    <label class="switch">
                        <input class="checkbox-switch" type="checkbox" checked>
                        <span class="slider round"></span>
                    </label>
                    <span class="text">Sprint</span>
                </div>
                <div id="btn-trunk" class="toggle-button col-2">
                    <label class="switch">
                        <input class="checkbox-switch" type="checkbox" checked>
                        <span class="slider round"></span>
                    </label>
                    <span class="text">Trunk</span>
                </div>
                <input type="text" class="search-box col-3" placeholder="Pesquisar..">
                <div class="buttons col-3">
                    <!-- <input type="submit" class="btn-base" value="Filtrar"> -->
                    <input id="btn-compile" type="submit" class="btn-base compiler" value="Compilar!">
                </div>
            </div>
        </div>

        <div id="table" class="filter">
            <%= pre_save %>
        </div>

        <footer>
            <span>Â© 2018 Gabriel Felipe. All Rights Reserved.</span>
        </footer>
    </div>
    <script type="text/javascript">
        $(document).ready(function () {
                str = $('#table').text();
                html = $.parseHTML(str);
                $('#table').html(html);

                $("#checkAll").click(function(){
                    $('input:checkbox').not('.checkbox-switch').each(function(index, value) {
                        if($(this).is(':visible')){
                            $(this).prop('checked', !this.checked);
                        }
                    });
                    $(this).prop('checked', !this.checked);
                });

                $('input:checkbox').not('.checkbox-switch').not('#checkAll').click(function(e){
                    if ($('input[type=checkbox]:checked').not('.checkbox-switch').not('#checkAll').length == 1) {
                        $('#checkAll').prop('checked', true);
                    }
                    if ($('input[type=checkbox]:checked').not('.checkbox-switch').not('#checkAll').not(this).length == 0) {
                        $('#checkAll').prop('checked', this.checked);
                    }
                });

                function SearchBarFilter() {
                    var value = $(".search-box").val().toLowerCase();
                    $("#table table tbody tr").filter(function() {
                        $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                    });
                }
                
                $(".search-box").on("keyup", function() {
                    SearchBarFilter();
                });

                $('#btn-sprint').click(function () {
                    if ($('#btn-sprint label input').prop('checked')) {
                        if($('#btn-trunk label input').prop('checked')) {
                            $("#table table tbody tr").filter(function() {
                                $(this).toggle($(this).text().toLowerCase().indexOf('') > -1)
                            });
                        } else {
                            $("#table table tbody tr").filter(function() {
                                $(this).toggle($(this).text().toLowerCase().indexOf('sprint') > -1)
                            });
                        }
                    } else{
                        if (!$('#btn-trunk label input').prop('checked')) {
                            $("#table table tbody tr").filter(function() {
                                $(this).toggle($(this).text().toLowerCase().indexOf('sprint') == -1 && $(this).text().toLowerCase().indexOf('trunk') == -1)
                            });
                        } else {
                            $("#table table tbody tr").filter(function() {
                                $(this).toggle($(this).text().toLowerCase().indexOf('sprint') == -1)
                            });
                        }
                    }

                    if ( $(".search-box").val().toLowerCase().length > 0 ) {
                        SearchBarFilter();
                    }
                });

                $('#btn-trunk').click(function () {
                    if ($('#btn-trunk label input').prop('checked')) {
                        if($('#btn-sprint label input').prop('checked')) {
                            $("#table table tbody tr").filter(function() {
                                $(this).toggle($(this).text().toLowerCase().indexOf('') > -1)
                            });
                        } else {
                            $("#table table tbody tr").filter(function() {
                                $(this).toggle($(this).text().toLowerCase().indexOf('trunk') > -1)
                            });
                        }
                    } else{
                        if (!$('#btn-sprint label input').prop('checked')) {
                            $("#table table tbody tr").filter(function() {
                                $(this).toggle($(this).text().toLowerCase().indexOf('trunk') == -1 && $(this).text().toLowerCase().indexOf('sprint') == -1)
                            });
                        } else {
                            $("#table table tbody tr").filter(function() {
                                $(this).toggle($(this).text().toLowerCase().indexOf('trunk') == -1)
                            });
                        }
                    }

                    if ( $(".search-box").val().toLowerCase().length > 0 ) {
                        SearchBarFilter();
                    }
                });

                var aDirecotories = [];
                var json = '';
                
                $('#btn-compile').click(function (){
                    json = '';
                    $('input[type="checkbox"]:checked').not('.checkbox-switch').not('#checkAll').each(function(index, value){
                        comma = index != $('input[type="checkbox"]:checked').not('.checkbox-switch').not('#checkAll').length -1 ? ',' : '';
                        json += ' "'+index+'": "'+$(this).val().split('\\').join('\\\\')+'" '+comma;
                    });
                    json = '{'+json+'}';

                    fetch('/index/clicked', {
                        method: 'POST',
                        body: json,
                        headers: {"Content-Type": "application/json"}
                      })
                    .then(function(response) {
                        if(response.ok) {
                            console.log('click was recorded');
                            return;
                        }
                        throw new Error('Request failed.');
                    })
                    .catch(function(error) {
                        console.log(error);
                    });
                    
                });
            });
            
        </script>
</body>
</html>
